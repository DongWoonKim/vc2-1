name: ì´ìŠˆ ìë™ í• ë‹¹

on:
  issues:
    types: [opened, reopened]

jobs:
  assign:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
      
    steps:
    - uses: actions/checkout@v4
    
    - name: ì´ìŠˆ ë¶„ì„ ë° í• ë‹¹ì ê²°ì •
      id: analyze
      env:
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_BODY: ${{ github.event.issue.body }}
      run: |
        title="$ISSUE_TITLE"
        body="$ISSUE_BODY"
        
        # ì´ìŠˆ íƒ€ì… ë¶„ì„
        if echo "$title" | grep -qi "^\[bug\]\|\bbug\b"; then
          echo "type=bug" >> $GITHUB_OUTPUT
          echo "assignee=maintainer" >> $GITHUB_OUTPUT
        elif echo "$title" | grep -qi "^\[feature\]\|\bfeature\b"; then
          echo "type=feature" >> $GITHUB_OUTPUT
          echo "assignee=product-owner" >> $GITHUB_OUTPUT
        elif echo "$title" | grep -qi "^\[question\]\|\bquestion\b"; then
          echo "type=question" >> $GITHUB_OUTPUT
          echo "assignee=maintainer" >> $GITHUB_OUTPUT
        elif echo "$title" | grep -qi "^\[enhancement\]\|\benhancement\b"; then
          echo "type=enhancement" >> $GITHUB_OUTPUT
          echo "assignee=maintainer" >> $GITHUB_OUTPUT
        elif echo "$title" | grep -qi "^\[docs\]\|\bdocs\b\|\bdocumentation\b"; then
          echo "type=documentation" >> $GITHUB_OUTPUT
          echo "assignee=docs-team" >> $GITHUB_OUTPUT
        else
          echo "type=general" >> $GITHUB_OUTPUT
          echo "assignee=maintainer" >> $GITHUB_OUTPUT
        fi
        
        # ì»´í¬ë„ŒíŠ¸ ê¸°ë°˜ í• ë‹¹ì ê²°ì •
        if echo "$title $body" | grep -qi "backend\|api\|server\|fastapi"; then
          echo "component=backend" >> $GITHUB_OUTPUT
          echo "assignee=backend-team" >> $GITHUB_OUTPUT
        elif echo "$title $body" | grep -qi "frontend\|ui\|streamlit"; then
          echo "component=frontend" >> $GITHUB_OUTPUT
          echo "assignee=frontend-team" >> $GITHUB_OUTPUT
        elif echo "$title $body" | grep -qi "docs\|documentation\|readme"; then
          echo "component=docs" >> $GITHUB_OUTPUT
          echo "assignee=docs-team" >> $GITHUB_OUTPUT
        fi
        
    - name: ì´ìŠˆ í• ë‹¹ ì‹¤í–‰
      uses: actions/github-script@v7
      with:
        script: |
          const issueType = '${{ steps.analyze.outputs.type }}';
          const assigneeType = '${{ steps.analyze.outputs.assignee }}';
          const component = '${{ steps.analyze.outputs.component }}';
          
          // ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë§¤í•‘ (í™˜ê²½ì— ë§ê²Œ ìˆ˜ì • í•„ìš”)
          const assigneeMap = {
            'maintainer': ['${{ github.repository_owner }}'],
            'product-owner': ['${{ github.repository_owner }}'],
            'backend-team': ['${{ github.repository_owner }}'], // ì‹¤ì œ ë°±ì—”ë“œ íŒ€ì›ë“¤ë¡œ ë³€ê²½
            'frontend-team': ['${{ github.repository_owner }}'], // ì‹¤ì œ í”„ë¡ íŠ¸ì—”ë“œ íŒ€ì›ë“¤ë¡œ ë³€ê²½
            'docs-team': ['${{ github.repository_owner }}'] // ì‹¤ì œ ë¬¸ì„œíŒ€ì›ë“¤ë¡œ ë³€ê²½
          };
          
          const assignees = assigneeMap[assigneeType] || assigneeMap['maintainer'];
          
          // ìš°ì„ ìˆœìœ„ì— ë”°ë¥¸ í• ë‹¹ì ì„ íƒ (ì—¬ëŸ¬ ëª…ì¼ ê²½ìš° ëœë¤ ì„ íƒ)
          const selectedAssignee = assignees[Math.floor(Math.random() * assignees.length)];
          
          try {
            // ì´ìŠˆ í• ë‹¹
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              assignees: [selectedAssignee]
            });
            
            console.log(`ì´ìŠˆê°€ ${selectedAssignee}ì—ê²Œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            // í• ë‹¹ ì™„ë£Œ ëŒ“ê¸€
            const assignmentComment = `## ğŸ‘¥ ë‹´ë‹¹ì ìë™ í• ë‹¹ ì™„ë£Œ
            
            **í• ë‹¹ëœ ë‹´ë‹¹ì**: @${selectedAssignee}
            **í• ë‹¹ ê¸°ì¤€**: ${issueType} íƒ€ì…, ${component || 'general'} ì»´í¬ë„ŒíŠ¸
            
            ### ğŸ“‹ ë‹´ë‹¹ì ì—­í• 
            - ì´ìŠˆ ë‚´ìš© ê²€í†  ë° ë¶„ì„
            - í•´ê²° ë°©ì•ˆ ìˆ˜ë¦½
            - êµ¬í˜„ ë˜ëŠ” ë‹µë³€ ì œê³µ
            - ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
            
            ### ğŸ”„ ë‹¤ìŒ ë‹¨ê³„
            1. **ë‹´ë‹¹ì ê²€í† **: ì´ìŠˆ ë‚´ìš© í™•ì¸ ë° ë¶„ì„
            2. **ë¼ë²¨ ì¶”ê°€**: ìƒì„¸ ë¶„ë¥˜ë¥¼ ìœ„í•œ ë¼ë²¨ ì¶”ê°€
            3. **ì¼ì • ìˆ˜ë¦½**: í•´ê²° ì˜ˆìƒ ì‹œê°„ ì•ˆë‚´
            4. **ì§„í–‰ ìƒí™© ê³µìœ **: ì •ê¸°ì ì¸ ì—…ë°ì´íŠ¸
            
            ---
            *ë‹´ë‹¹ì ë³€ê²½ì´ í•„ìš”í•˜ê±°ë‚˜ ì¶”ê°€ ì •ë³´ê°€ í•„ìš”í•˜ë©´ ëŒ“ê¸€ë¡œ ë‚¨ê²¨ì£¼ì„¸ìš”.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: assignmentComment
            });
            
          } catch (error) {
            console.error('í• ë‹¹ ì‹¤íŒ¨:', error.message);
            
            // í• ë‹¹ ì‹¤íŒ¨ ëŒ“ê¸€
            const errorComment = `## âŒ ìë™ í• ë‹¹ ì‹¤íŒ¨
            
            ë‹´ë‹¹ì ìë™ í• ë‹¹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            **ì˜¤ë¥˜**: ${error.message}
            
            **ìˆ˜ë™ í• ë‹¹ ë°©ë²•**:
            1. ì˜¤ë¥¸ìª½ ì‚¬ì´ë“œë°”ì—ì„œ "Assignees" í´ë¦­
            2. ì ì ˆí•œ ë‹´ë‹¹ì ì„ íƒ
            3. ë˜ëŠ” ëŒ“ê¸€ì—ì„œ @username ë©˜ì…˜
            
            **ì¶”ì²œ ë‹´ë‹¹ì**:
            - ë²„ê·¸ ì´ìŠˆ: @maintainer
            - ê¸°ëŠ¥ ìš”ì²­: @product-owner  
            - ë¬¸ì„œ ì´ìŠˆ: @docs-team
            - ë°±ì—”ë“œ ê´€ë ¨: @backend-team
            - í”„ë¡ íŠ¸ì—”ë“œ ê´€ë ¨: @frontend-team
            
            ---
            *ì‹œìŠ¤í…œ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì—¬ ìë™ í• ë‹¹ ê¸°ëŠ¥ì„ ì ê²€í•´ì£¼ì„¸ìš”.*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: errorComment
            });
          } 