name: PR ë¼ë²¨ ìë™ ë“±ë¡

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ë³€ê²½ì‚¬í•­ ë¶„ì„
      id: analyze
      run: |
        git fetch origin ${{ github.base_ref }}
        echo "=== ë³€ê²½ëœ íŒŒì¼ ë¶„ì„ ==="
        git diff --name-only origin/${{ github.base_ref }}...HEAD
        
        # ì»´í¬ë„ŒíŠ¸ ë¼ë²¨
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^backend/"; then
          echo "component_backend=true" >> $GITHUB_OUTPUT
        fi
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^frontend/"; then
          echo "component_frontend=true" >> $GITHUB_OUTPUT
        fi
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "\.md$\|^docs/"; then
          echo "component_docs=true" >> $GITHUB_OUTPUT
        fi
        
        # íƒ€ì… ë¼ë²¨
        if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "test_.*\.py$\|_test\.py$"; then
          echo "type_test=true" >> $GITHUB_OUTPUT
        fi
        
        # ë³€ê²½ì‚¬í•­ í¬ê¸° ë¶„ì„
        files_changed=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
        lines_changed=$(git diff --numstat origin/${{ github.base_ref }}...HEAD | awk '{sum+=$1+$2} END {print sum}')
        
        echo "files_changed=$files_changed" >> $GITHUB_OUTPUT
        echo "lines_changed=$lines_changed" >> $GITHUB_OUTPUT
        
        # í¬ê¸° ë¼ë²¨ ê²°ì •
        if [ "$lines_changed" -lt 50 ]; then
          echo "size=S" >> $GITHUB_OUTPUT
        elif [ "$lines_changed" -lt 200 ]; then
          echo "size=M" >> $GITHUB_OUTPUT
        elif [ "$lines_changed" -lt 500 ]; then
          echo "size=L" >> $GITHUB_OUTPUT
        else
          echo "size=XL" >> $GITHUB_OUTPUT
        fi
        
        # PR ì œëª© ê¸°ë°˜ íƒ€ì… ë¶„ì„
        title="${{ github.event.pull_request.title }}"
        if echo "$title" | grep -qi "^\[feat\]"; then
          echo "type_feature=true" >> $GITHUB_OUTPUT
        elif echo "$title" | grep -qi "^\[fix\]"; then
          echo "type_bugfix=true" >> $GITHUB_OUTPUT
        elif echo "$title" | grep -qi "^\[docs\]"; then
          echo "type_docs=true" >> $GITHUB_OUTPUT
        elif echo "$title" | grep -qi "^\[refactor\]"; then
          echo "type_refactor=true" >> $GITHUB_OUTPUT
        fi
        
    - name: ë¼ë²¨ ì ìš©
      uses: actions/github-script@v7
      with:
        script: |
          const labels = [];
          
          // ì»´í¬ë„ŒíŠ¸ ë¼ë²¨
          if ('${{ steps.analyze.outputs.component_backend }}' === 'true') {
            labels.push('component/backend');
          }
          if ('${{ steps.analyze.outputs.component_frontend }}' === 'true') {
            labels.push('component/frontend');
          }
          if ('${{ steps.analyze.outputs.component_docs }}' === 'true') {
            labels.push('component/docs');
          }
          
          // íƒ€ì… ë¼ë²¨
          if ('${{ steps.analyze.outputs.type_feature }}' === 'true') {
            labels.push('type/feature');
          }
          if ('${{ steps.analyze.outputs.type_bugfix }}' === 'true') {
            labels.push('type/bugfix');
          }
          if ('${{ steps.analyze.outputs.type_docs }}' === 'true') {
            labels.push('type/docs');
          }
          if ('${{ steps.analyze.outputs.type_refactor }}' === 'true') {
            labels.push('type/refactor');
          }
          if ('${{ steps.analyze.outputs.type_test }}' === 'true') {
            labels.push('type/test');
          }
          
          // í¬ê¸° ë¼ë²¨
          const size = '${{ steps.analyze.outputs.size }}';
          labels.push(`size/${size}`);
          
          // ìƒíƒœ ë¼ë²¨
          labels.push('status/needs-review');
          
          // ìš°ì„ ìˆœìœ„ ë¼ë²¨ (ê¸°ë³¸ê°’)
          labels.push('priority/medium');
          
          console.log('ì ìš©í•  ë¼ë²¨:', labels);
          
          // ë¼ë²¨ ì ìš©
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labels
            });
          }
          
          // ëŒ“ê¸€ë¡œ ë¼ë²¨ ì •ë³´ ì•Œë¦¼
          const comment = `## ğŸ·ï¸ ìë™ ë¼ë²¨ë§ ì™„ë£Œ
          
          **ì ìš©ëœ ë¼ë²¨**: ${labels.map(l => `\`${l}\``).join(', ')}
          
          **ë¶„ì„ ê²°ê³¼**:
          - ë³€ê²½ëœ íŒŒì¼: ${{ steps.analyze.outputs.files_changed }}ê°œ
          - ë³€ê²½ëœ ë¼ì¸: ${{ steps.analyze.outputs.lines_changed }}ì¤„
          - í¬ê¸°: ${{ steps.analyze.outputs.size }}
          
          ---
          *ë¼ë²¨ì€ ë³€ê²½ì‚¬í•­ì„ ê¸°ë°˜ìœ¼ë¡œ ìë™ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤. í•„ìš”ì‹œ ìˆ˜ë™ìœ¼ë¡œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.*`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          }); 